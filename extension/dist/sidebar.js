alert("Script is running!");const y=document.getElementById("message-input"),i=document.getElementById("send-btn"),l=document.querySelector(".chat-container"),m=document.getElementById("clear-chat-button"),r=document.getElementById("stop-btn");let a=!1,d=!1,c=null,o="";const g="user";async function u(e,n){const t=document.createElement("div");t.className=`bubble ${e==="bot"?"bot-message":"user-message"}`;const s=document.createElement("span");t.appendChild(s),l.appendChild(t),l.scrollTop=l.scrollHeight,e==="bot"?(a=!0,c=s,o=n,await f(n,s)):s.innerHTML=p(n),l.scrollTop=l.scrollHeight}const f=async(e,n)=>{for(let t=0;t<e.length&&a;t++)n.innerHTML+=e[t]===`
`?"<br>":e[t],await new Promise(s=>setTimeout(s,1));a&&(n.innerHTML=p(e)),a=!1,c=null,o=""};i.addEventListener("click",async()=>{const e=y.value.trim();if(!e)return;i.disabled=!0,d=!1,r.style.display="block",i.style.display="none",u("user",e),y.value="";const n=document.createElement("div");n.className="bubble bot-message",n.innerHTML=`
    <div class="loading">
      <div class="line"></div><div class="line"></div><div class="line"></div>
    </div>`,l.appendChild(n),chrome.runtime.sendMessage({type:"ask-gemini",userId:g,question:e},async t=>{var s;l.removeChild(n),!d&&(t!=null&&t.answer)?await u("bot",typeof t.answer=="string"?t.answer:((s=t.answer)==null?void 0:s.content)??JSON.stringify(t.answer)):d||await u("bot","Sorry, something went wrong."),r.style.display="none",i.style.display="block",i.disabled=!1})});r.addEventListener("click",()=>{a=!1,d=!0;const e=l.lastChild;if(e&&e.classList.contains("bot-message")){const n=e.querySelector("span");n&&!n.innerHTML.includes("[stopped]")&&(n.innerHTML+="<em> ...[stopped]</em>")}r.style.display="none",i.style.display="block",i.disabled=!1});y.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),i.click())});m.addEventListener("click",async()=>{l.innerHTML="",r.style.display="none",i.style.display="block",chrome.runtime.sendMessage({type:"reset-chat",userId:g})});function b(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function p(e){return b(e).replace(/\n/g,"<br>")}document.addEventListener("visibilitychange",()=>{!document.hidden&&a&&c&&(c.innerHTML=p(o),a=!1,c=null,o="")});
