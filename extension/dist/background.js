import{_ as ee,h as te,e as R,a as U,R as V,b as ne,c as He,d as Be,f as Re,B as Ye,C as $,i as se,g as D,j as qe,k as ae,l as z,m as X,H as M,n as We,o as K,t as Ne,p as Je,q as Pe,r as Ve,s as ze,u as Xe,v as Qe,w as Ze,x as q,y as et,G as tt,z as nt,A as oe,D as W,E as st,F as at,I as ot,J as ke,K as rt,L as it,M as H,N as ut,O as lt,P as xe}from"./tools.js";var re;(function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"})(re||(re={}));/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ie;(function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"})(ie||(ie={}));var ue;(function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(ue||(ue={}));/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const le=["user","model","function","system"];var ce;(function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",e.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"})(ce||(ce={}));var de;(function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"})(de||(de={}));var fe;(function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"})(fe||(fe={}));var he;(function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"})(he||(he={}));var k;(function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.BLOCKLIST="BLOCKLIST",e.PROHIBITED_CONTENT="PROHIBITED_CONTENT",e.SPII="SPII",e.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",e.OTHER="OTHER"})(k||(k={}));var me;(function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"})(me||(me={}));var P;(function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"})(P||(P={}));var pe;(function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"})(pe||(pe={}));/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class v extends Error{constructor(t){super(`[GoogleGenerativeAI Error]: ${t}`)}}class N extends v{constructor(t,n){super(t),this.response=n}}class Le extends v{constructor(t,n,s,a){super(t),this.status=n,this.statusText=s,this.errorDetails=a}}class I extends v{}class Ge extends v{}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ct="https://generativelanguage.googleapis.com",dt="v1beta",ft="0.24.1",ht="genai-js";var S;(function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"})(S||(S={}));class mt{constructor(t,n,s,a,r){this.model=t,this.task=n,this.apiKey=s,this.stream=a,this.requestOptions=r}toString(){var t,n;const s=((t=this.requestOptions)===null||t===void 0?void 0:t.apiVersion)||dt;let r=`${((n=this.requestOptions)===null||n===void 0?void 0:n.baseUrl)||ct}/${s}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}function pt(e){const t=[];return e!=null&&e.apiClient&&t.push(e.apiClient),t.push(`${ht}/${ft}`),t.join(" ")}async function gt(e){var t;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",pt(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let s=(t=e.requestOptions)===null||t===void 0?void 0:t.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(a){throw new I(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${a.message}`)}for(const[a,r]of s.entries()){if(a==="x-goog-api-key")throw new I(`Cannot set reserved header name ${a}`);if(a==="x-goog-api-client")throw new I(`Header name ${a} can only be set using the apiClient field`);n.append(a,r)}}return n}async function yt(e,t,n,s,a,r){const o=new mt(e,t,n,s,r);return{url:o.toString(),fetchOptions:Object.assign(Object.assign({},vt(r)),{method:"POST",headers:await gt(o),body:a})}}async function G(e,t,n,s,a,r={},o=fetch){const{url:i,fetchOptions:d}=await yt(e,t,n,s,a,r);return _t(i,d,o)}async function _t(e,t,n=fetch){let s;try{s=await n(e,t)}catch(a){wt(a,e)}return s.ok||await Ct(s,e),s}function wt(e,t){let n=e;throw n.name==="AbortError"?(n=new Ge(`Request aborted when fetching ${t.toString()}: ${e.message}`),n.stack=e.stack):e instanceof Le||e instanceof I||(n=new v(`Error fetching from ${t.toString()}: ${e.message}`),n.stack=e.stack),n}async function Ct(e,t){let n="",s;try{const a=await e.json();n=a.error.message,a.error.details&&(n+=` ${JSON.stringify(a.error.details)}`,s=a.error.details)}catch{}throw new Le(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${n}`,e.status,e.statusText,s)}function vt(e){const t={};if((e==null?void 0:e.signal)!==void 0||(e==null?void 0:e.timeout)>=0){const n=new AbortController;(e==null?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),e!=null&&e.signal&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Q(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new N(`${E(e)}`,e);return bt(e)}else if(e.promptFeedback)throw new N(`Text not available. ${E(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new N(`${E(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),ge(e)[0]}else if(e.promptFeedback)throw new N(`Function call not available. ${E(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new N(`${E(e)}`,e);return ge(e)}else if(e.promptFeedback)throw new N(`Function call not available. ${E(e)}`,e)},e}function bt(e){var t,n,s,a;const r=[];if(!((n=(t=e.candidates)===null||t===void 0?void 0:t[0].content)===null||n===void 0)&&n.parts)for(const o of(a=(s=e.candidates)===null||s===void 0?void 0:s[0].content)===null||a===void 0?void 0:a.parts)o.text&&r.push(o.text),o.executableCode&&r.push("\n```"+o.executableCode.language+`
`+o.executableCode.code+"\n```\n"),o.codeExecutionResult&&r.push("\n```\n"+o.codeExecutionResult.output+"\n```\n");return r.length>0?r.join(""):""}function ge(e){var t,n,s,a;const r=[];if(!((n=(t=e.candidates)===null||t===void 0?void 0:t[0].content)===null||n===void 0)&&n.parts)for(const o of(a=(s=e.candidates)===null||s===void 0?void 0:s[0].content)===null||a===void 0?void 0:a.parts)o.functionCall&&r.push(o.functionCall);if(r.length>0)return r}const Et=[k.RECITATION,k.SAFETY,k.LANGUAGE];function j(e){return!!e.finishReason&&Et.includes(e.finishReason)}function E(e){var t,n,s;let a="";if((!e.candidates||e.candidates.length===0)&&e.promptFeedback)a+="Response was blocked",!((t=e.promptFeedback)===null||t===void 0)&&t.blockReason&&(a+=` due to ${e.promptFeedback.blockReason}`),!((n=e.promptFeedback)===null||n===void 0)&&n.blockReasonMessage&&(a+=`: ${e.promptFeedback.blockReasonMessage}`);else if(!((s=e.candidates)===null||s===void 0)&&s[0]){const r=e.candidates[0];j(r)&&(a+=`Candidate was blocked due to ${r.finishReason}`,r.finishMessage&&(a+=`: ${r.finishMessage}`))}return a}function x(e){return this instanceof x?(this.v=e,this):new x(e)}function Ot(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=n.apply(e,t||[]),a,r=[];return a={},o("next"),o("throw"),o("return"),a[Symbol.asyncIterator]=function(){return this},a;function o(l){s[l]&&(a[l]=function(f){return new Promise(function(c,p){r.push([l,f,c,p])>1||i(l,f)})})}function i(l,f){try{d(s[l](f))}catch(c){m(r[0][3],c)}}function d(l){l.value instanceof x?Promise.resolve(l.value.v).then(u,h):m(r[0][2],l)}function u(l){i("next",l)}function h(l){i("throw",l)}function m(l,f){l(f),r.shift(),r.length&&i(r[0][0],r[0][1])}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ye=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function It(e){const t=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),n=At(t),[s,a]=n.tee();return{stream:St(s),response:Tt(a)}}async function Tt(e){const t=[],n=e.getReader();for(;;){const{done:s,value:a}=await n.read();if(s)return Q(Rt(t));t.push(a)}}function St(e){return Ot(this,arguments,function*(){const n=e.getReader();for(;;){const{value:s,done:a}=yield x(n.read());if(a)break;yield yield x(Q(s))}})}function At(e){const t=e.getReader();return new ReadableStream({start(s){let a="";return r();function r(){return t.read().then(({value:o,done:i})=>{if(i){if(a.trim()){s.error(new v("Failed to parse stream"));return}s.close();return}a+=o;let d=a.match(ye),u;for(;d;){try{u=JSON.parse(d[1])}catch{s.error(new v(`Error parsing JSON response: "${d[1]}"`));return}s.enqueue(u),a=a.substring(d[0].length),d=a.match(ye)}return r()}).catch(o=>{let i=o;throw i.stack=o.stack,i.name==="AbortError"?i=new Ge("Request aborted when reading from the stream"):i=new v("Error reading from the stream"),i})}}})}function Rt(e){const t=e[e.length-1],n={promptFeedback:t==null?void 0:t.promptFeedback};for(const s of e){if(s.candidates){let a=0;for(const r of s.candidates)if(n.candidates||(n.candidates=[]),n.candidates[a]||(n.candidates[a]={index:a}),n.candidates[a].citationMetadata=r.citationMetadata,n.candidates[a].groundingMetadata=r.groundingMetadata,n.candidates[a].finishReason=r.finishReason,n.candidates[a].finishMessage=r.finishMessage,n.candidates[a].safetyRatings=r.safetyRatings,r.content&&r.content.parts){n.candidates[a].content||(n.candidates[a].content={role:r.content.role||"user",parts:[]});const o={};for(const i of r.content.parts)i.text&&(o.text=i.text),i.functionCall&&(o.functionCall=i.functionCall),i.executableCode&&(o.executableCode=i.executableCode),i.codeExecutionResult&&(o.codeExecutionResult=i.codeExecutionResult),Object.keys(o).length===0&&(o.text=""),n.candidates[a].content.parts.push(o)}a++}s.usageMetadata&&(n.usageMetadata=s.usageMetadata)}return n}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Ue(e,t,n,s){const a=await G(t,S.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),s);return It(a)}async function De(e,t,n,s){const r=await(await G(t,S.GENERATE_CONTENT,e,!1,JSON.stringify(n),s)).json();return{response:Q(r)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Me(e){if(e!=null){if(typeof e=="string")return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)return e.role?e:{role:"system",parts:e.parts}}}function L(e){let t=[];if(typeof e=="string")t=[{text:e}];else for(const n of e)typeof n=="string"?t.push({text:n}):t.push(n);return Nt(t)}function Nt(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let s=!1,a=!1;for(const r of e)"functionResponse"in r?(n.parts.push(r),a=!0):(t.parts.push(r),s=!0);if(s&&a)throw new v("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!s&&!a)throw new v("No content is provided for sending chat message.");return s?t:n}function Pt(e,t){var n;let s={model:t==null?void 0:t.model,generationConfig:t==null?void 0:t.generationConfig,safetySettings:t==null?void 0:t.safetySettings,tools:t==null?void 0:t.tools,toolConfig:t==null?void 0:t.toolConfig,systemInstruction:t==null?void 0:t.systemInstruction,cachedContent:(n=t==null?void 0:t.cachedContent)===null||n===void 0?void 0:n.name,contents:[]};const a=e.generateContentRequest!=null;if(e.contents){if(a)throw new I("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=e.contents}else if(a)s=Object.assign(Object.assign({},s),e.generateContentRequest);else{const r=L(e);s.contents=[r]}return{generateContentRequest:s}}function _e(e){let t;return e.contents?t=e:t={contents:[L(e)]},e.systemInstruction&&(t.systemInstruction=Me(e.systemInstruction)),t}function kt(e){return typeof e=="string"||Array.isArray(e)?{content:L(e)}:e}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const we=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],xt={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function Lt(e){let t=!1;for(const n of e){const{role:s,parts:a}=n;if(!t&&s!=="user")throw new v(`First content should be with role 'user', got ${s}`);if(!le.includes(s))throw new v(`Each item should include role field. Got ${s} but valid roles are: ${JSON.stringify(le)}`);if(!Array.isArray(a))throw new v("Content should have 'parts' property with an array of Parts");if(a.length===0)throw new v("Each Content should have at least one part");const r={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const i of a)for(const d of we)d in i&&(r[d]+=1);const o=xt[s];for(const i of we)if(!o.includes(i)&&r[i]>0)throw new v(`Content with role '${s}' can't contain '${i}' part`);t=!0}}function Ce(e){var t;if(e.candidates===void 0||e.candidates.length===0)return!1;const n=(t=e.candidates[0])===null||t===void 0?void 0:t.content;if(n===void 0||n.parts===void 0||n.parts.length===0)return!1;for(const s of n.parts)if(s===void 0||Object.keys(s).length===0||s.text!==void 0&&s.text==="")return!1;return!0}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ve="SILENT_ERROR";class Gt{constructor(t,n,s,a={}){this.model=n,this.params=s,this._requestOptions=a,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=t,s!=null&&s.history&&(Lt(s.history),this._history=s.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(t,n={}){var s,a,r,o,i,d;await this._sendPromise;const u=L(t),h={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(r=this.params)===null||r===void 0?void 0:r.tools,toolConfig:(o=this.params)===null||o===void 0?void 0:o.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,cachedContent:(d=this.params)===null||d===void 0?void 0:d.cachedContent,contents:[...this._history,u]},m=Object.assign(Object.assign({},this._requestOptions),n);let l;return this._sendPromise=this._sendPromise.then(()=>De(this._apiKey,this.model,h,m)).then(f=>{var c;if(Ce(f.response)){this._history.push(u);const p=Object.assign({parts:[],role:"model"},(c=f.response.candidates)===null||c===void 0?void 0:c[0].content);this._history.push(p)}else{const p=E(f.response);p&&console.warn(`sendMessage() was unsuccessful. ${p}. Inspect response object for details.`)}l=f}).catch(f=>{throw this._sendPromise=Promise.resolve(),f}),await this._sendPromise,l}async sendMessageStream(t,n={}){var s,a,r,o,i,d;await this._sendPromise;const u=L(t),h={safetySettings:(s=this.params)===null||s===void 0?void 0:s.safetySettings,generationConfig:(a=this.params)===null||a===void 0?void 0:a.generationConfig,tools:(r=this.params)===null||r===void 0?void 0:r.tools,toolConfig:(o=this.params)===null||o===void 0?void 0:o.toolConfig,systemInstruction:(i=this.params)===null||i===void 0?void 0:i.systemInstruction,cachedContent:(d=this.params)===null||d===void 0?void 0:d.cachedContent,contents:[...this._history,u]},m=Object.assign(Object.assign({},this._requestOptions),n),l=Ue(this._apiKey,this.model,h,m);return this._sendPromise=this._sendPromise.then(()=>l).catch(f=>{throw new Error(ve)}).then(f=>f.response).then(f=>{if(Ce(f)){this._history.push(u);const c=Object.assign({},f.candidates[0].content);c.role||(c.role="model"),this._history.push(c)}else{const c=E(f);c&&console.warn(`sendMessageStream() was unsuccessful. ${c}. Inspect response object for details.`)}}).catch(f=>{f.message!==ve&&console.error(f)}),l}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Ut(e,t,n,s){return(await G(t,S.COUNT_TOKENS,e,!1,JSON.stringify(n),s)).json()}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Dt(e,t,n,s){return(await G(t,S.EMBED_CONTENT,e,!1,JSON.stringify(n),s)).json()}async function Mt(e,t,n,s){const a=n.requests.map(o=>Object.assign(Object.assign({},o),{model:t}));return(await G(t,S.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:a}),s)).json()}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class be{constructor(t,n,s={}){this.apiKey=t,this._requestOptions=s,n.model.includes("/")?this.model=n.model:this.model=`models/${n.model}`,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Me(n.systemInstruction),this.cachedContent=n.cachedContent}async generateContent(t,n={}){var s;const a=_e(t),r=Object.assign(Object.assign({},this._requestOptions),n);return De(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},a),r)}async generateContentStream(t,n={}){var s;const a=_e(t),r=Object.assign(Object.assign({},this._requestOptions),n);return Ue(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(s=this.cachedContent)===null||s===void 0?void 0:s.name},a),r)}startChat(t){var n;return new Gt(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},t),this._requestOptions)}async countTokens(t,n={}){const s=Pt(t,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),a=Object.assign(Object.assign({},this._requestOptions),n);return Ut(this.apiKey,this.model,s,a)}async embedContent(t,n={}){const s=kt(t),a=Object.assign(Object.assign({},this._requestOptions),n);return Dt(this.apiKey,this.model,s,a)}async batchEmbedContents(t,n={}){const s=Object.assign(Object.assign({},this._requestOptions),n);return Mt(this.apiKey,this.model,t,s)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ee{constructor(t){this.apiKey=t}getGenerativeModel(t,n){if(!t.model)throw new v("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new be(this.apiKey,t,n)}getGenerativeModelFromCachedContent(t,n,s){if(!t.name)throw new I("Cached content must contain a `name` field.");if(!t.model)throw new I("Cached content must contain a `model` field.");const a=["model","systemInstruction"];for(const o of a)if(n!=null&&n[o]&&t[o]&&(n==null?void 0:n[o])!==t[o]){if(o==="model"){const i=n.model.startsWith("models/")?n.model.replace("models/",""):n.model,d=t.model.startsWith("models/")?t.model.replace("models/",""):t.model;if(i===d)continue}throw new I(`Different value for "${o}" specified in modelParams (${n[o]}) and cachedContent (${t[o]})`)}const r=Object.assign(Object.assign({},n),{model:t.model,tools:t.tools,toolConfig:t.toolConfig,systemInstruction:t.systemInstruction,cachedContent:t});return new be(this.apiKey,r,s)}}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function je(e,t,n,s,a){if(t!==e){typeof t.toJSON=="function"&&(t=t.toJSON());for(var r=ee(t),o=ee(e),i=!1,d=o.length-1;d>=0;d--){var u=o[d],h=e[u];if(te(t,u)&&!(t[u]===void 0&&h!==void 0&&Array.isArray(t)===!1)){var m=t[u];typeof h=="object"&&h!=null&&typeof m=="object"&&m!=null&&Array.isArray(h)===Array.isArray(m)?je(h,m,n,s+"/"+R(u),a):h!==m&&(a&&n.push({op:"test",path:s+"/"+R(u),value:U(h)}),n.push({op:"replace",path:s+"/"+R(u),value:U(m)}))}else Array.isArray(e)===Array.isArray(t)?(a&&n.push({op:"test",path:s+"/"+R(u),value:U(h)}),n.push({op:"remove",path:s+"/"+R(u)}),i=!0):(a&&n.push({op:"test",path:s,value:e}),n.push({op:"replace",path:s,value:t}))}if(!(!i&&r.length==o.length))for(var d=0;d<r.length;d++){var u=r[d];!te(e,u)&&t[u]!==void 0&&n.push({op:"add",path:s+"/"+R(u),value:U(t[u])})}}}function jt(e,t,n=!1){var s=[];return je(e,t,s,"",n),s}class F extends V{static lc_name(){return"RunnablePassthrough"}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),t&&(this.func=t.func)}async invoke(t,n){const s=ne(n);return this.func&&await this.func(t,s),this._callWithConfig(a=>Promise.resolve(a),t,s)}async*transform(t,n){const s=ne(n);let a,r=!0;for await(const o of this._transformStreamWithConfig(t,i=>i,s))if(yield o,r)if(a===void 0)a=o;else try{a=Re(a,o)}catch{a=void 0,r=!1}this.func&&a!==void 0&&await this.func(a,s)}static assign(t){return new He(new Be({steps:t}))}}function B(e){const t=[];for(const n of e){let s=n;if(Array.isArray(n.content))for(let a=0;a<n.content.length;a++){const r=n.content[a];(Ve(r)||ze(r))&&s===n&&(s=new n.constructor({...s,content:[...n.content.slice(0,a),Xe(r),...n.content.slice(a+1)]}))}t.push(s)}return t}class O extends Ye{constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(t){const[n,s]=super._separateRunnableConfigFromCallOptions(t);return s.signal=n.signal,[n,s]}async invoke(t,n){const s=O._convertInputToPromptValue(t);return(await this.generatePrompt([s],n,n==null?void 0:n.callbacks)).generations[0][0].message}async*_streamResponseChunks(t,n,s){throw new Error("Not implemented.")}async*_streamIterator(t,n){var s;if(this._streamResponseChunks===O.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(t,n);else{const r=O._convertInputToPromptValue(t).toChatMessages(),[o,i]=this._separateRunnableConfigFromCallOptionsCompat(n),d={...o.metadata,...this.getLsParams(i)},u=await $.configure(o.callbacks,this.callbacks,o.tags,this.tags,d,this.metadata,{verbose:this.verbose}),h={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},m=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),[B(r)],o.runId,void 0,h,void 0,void 0,o.runName));let l,f;try{for await(const c of this._streamResponseChunks(r,i,m==null?void 0:m[0])){if(c.message.id==null){const p=(s=m==null?void 0:m.at(0))==null?void 0:s.runId;p!=null&&c.message._updateId(`run-${p}`)}c.message.response_metadata={...c.generationInfo,...c.message.response_metadata},yield c.message,l?l=l.concat(c):l=c,se(c.message)&&c.message.usage_metadata!==void 0&&(f={tokenUsage:{promptTokens:c.message.usage_metadata.input_tokens,completionTokens:c.message.usage_metadata.output_tokens,totalTokens:c.message.usage_metadata.total_tokens}})}}catch(c){throw await Promise.all((m??[]).map(p=>p==null?void 0:p.handleLLMError(c))),c}await Promise.all((m??[]).map(c=>c==null?void 0:c.handleLLMEnd({generations:[[l]],llmOutput:f})))}}getLsParams(t){const n=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:t.stop,ls_provider:n}}async _generateUncached(t,n,s,a){var m,l;const r=t.map(f=>f.map(D));let o;if(a!==void 0&&a.length===r.length)o=a;else{const f={...s.metadata,...this.getLsParams(n)},c=await $.configure(s.callbacks,this.callbacks,s.tags,this.tags,f,this.metadata,{verbose:this.verbose}),p={options:n,invocation_params:this==null?void 0:this.invocationParams(n),batch_size:1};o=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),r.map(B),s.runId,void 0,p,void 0,void 0,s.runName))}const i=[],d=[];if(!!(o!=null&&o[0].handlers.find(qe))&&!this.disableStreaming&&r.length===1&&this._streamResponseChunks!==O.prototype._streamResponseChunks)try{const f=await this._streamResponseChunks(r[0],n,o==null?void 0:o[0]);let c,p;for await(const g of f){if(g.message.id==null){const y=(m=o==null?void 0:o.at(0))==null?void 0:m.runId;y!=null&&g.message._updateId(`run-${y}`)}c===void 0?c=g:c=Re(c,g),se(g.message)&&g.message.usage_metadata!==void 0&&(p={tokenUsage:{promptTokens:g.message.usage_metadata.input_tokens,completionTokens:g.message.usage_metadata.output_tokens,totalTokens:g.message.usage_metadata.total_tokens}})}if(c===void 0)throw new Error("Received empty response from chat model call.");i.push([c]),await(o==null?void 0:o[0].handleLLMEnd({generations:i,llmOutput:p}))}catch(f){throw await(o==null?void 0:o[0].handleLLMError(f)),f}else{const f=await Promise.allSettled(r.map((c,p)=>this._generate(c,{...n,promptIndex:p},o==null?void 0:o[p])));await Promise.all(f.map(async(c,p)=>{var g,y,_;if(c.status==="fulfilled"){const w=c.value;for(const b of w.generations){if(b.message.id==null){const Z=(g=o==null?void 0:o.at(0))==null?void 0:g.runId;Z!=null&&b.message._updateId(`run-${Z}`)}b.message.response_metadata={...b.generationInfo,...b.message.response_metadata}}return w.generations.length===1&&(w.generations[0].message.response_metadata={...w.llmOutput,...w.generations[0].message.response_metadata}),i[p]=w.generations,d[p]=w.llmOutput,(y=o==null?void 0:o[p])==null?void 0:y.handleLLMEnd({generations:[w.generations],llmOutput:w.llmOutput})}else return await((_=o==null?void 0:o[p])==null?void 0:_.handleLLMError(c.reason)),Promise.reject(c.reason)}))}const h={generations:i,llmOutput:d.length?(l=this._combineLLMOutput)==null?void 0:l.call(this,...d):void 0};return Object.defineProperty(h,ae,{value:o?{runIds:o==null?void 0:o.map(f=>f.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:t,cache:n,llmStringKey:s,parsedOptions:a,handledOptions:r}){const o=t.map(g=>g.map(D)),i={...r.metadata,...this.getLsParams(a)},d=await $.configure(r.callbacks,this.callbacks,r.tags,this.tags,i,this.metadata,{verbose:this.verbose}),u={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},h=await(d==null?void 0:d.handleChatModelStart(this.toJSON(),o.map(B),r.runId,void 0,u,void 0,void 0,r.runName)),m=[],f=(await Promise.allSettled(o.map(async(g,y)=>{const _=O._convertInputToPromptValue(g).toString(),w=await n.lookup(_,s);return w==null&&m.push(y),w}))).map((g,y)=>({result:g,runManager:h==null?void 0:h[y]})).filter(({result:g})=>g.status==="fulfilled"&&g.value!=null||g.status==="rejected"),c=[];await Promise.all(f.map(async({result:g,runManager:y},_)=>{if(g.status==="fulfilled"){const w=g.value;return c[_]=w.map(b=>("message"in b&&z(b.message)&&X(b.message)&&(b.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),b.generationInfo={...b.generationInfo,tokenUsage:{}},b)),w.length&&await(y==null?void 0:y.handleLLMNewToken(w[0].text)),y==null?void 0:y.handleLLMEnd({generations:[w]},void 0,void 0,void 0,{cached:!0})}else return await(y==null?void 0:y.handleLLMError(g.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(g.reason)}));const p={generations:c,missingPromptIndices:m,startedRunManagers:h};return Object.defineProperty(p,ae,{value:h?{runIds:h==null?void 0:h.map(g=>g.runId)}:void 0,configurable:!0}),p}async generate(t,n,s){let a;Array.isArray(n)?a={stop:n}:a=n;const r=t.map(c=>c.map(D)),[o,i]=this._separateRunnableConfigFromCallOptionsCompat(a);if(o.callbacks=o.callbacks??s,!this.cache)return this._generateUncached(r,i,o);const{cache:d}=this,u=this._getSerializedCacheKeyParametersForCall(i),{generations:h,missingPromptIndices:m,startedRunManagers:l}=await this._generateCached({messages:r,cache:d,llmStringKey:u,parsedOptions:i,handledOptions:o});let f={};if(m.length>0){const c=await this._generateUncached(m.map(p=>r[p]),i,o,l!==void 0?m.map(p=>l==null?void 0:l[p]):void 0);await Promise.all(c.generations.map(async(p,g)=>{const y=m[g];h[y]=p;const _=O._convertInputToPromptValue(r[y]).toString();return d.update(_,u,p)})),f=c.llmOutput??{}}return{generations:h,llmOutput:f}}invocationParams(t){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(t,n,s){const a=t.map(r=>r.toChatMessages());return this.generate(a,n,s)}async call(t,n,s){return(await this.generate([t.map(D)],n,s)).generations[0][0].message}async callPrompt(t,n,s){const a=t.toChatMessages();return this.call(a,n,s)}async predictMessages(t,n,s){return this.call(t,n,s)}async predict(t,n,s){const a=new M(t),r=await this.call([a],n,s);if(typeof r.content!="string")throw new Error("Cannot use predict when output is not a string.");return r.content}withStructuredOutput(t,n){if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(n!=null&&n.strict)throw new Error('"strict" mode is not supported for this model by default.');const s=t,a=n==null?void 0:n.name,r=We(s)??"A function available to call.",o=n==null?void 0:n.method,i=n==null?void 0:n.includeRaw;if(o==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let d=a??"extract",u;K(s)?u=[{type:"function",function:{name:d,description:r,parameters:Ne(s)}}]:("name"in s&&(d=s.name),u=[{type:"function",function:{name:d,description:r,parameters:s}}]);const h=this.bindTools(u),m=Je.from(p=>{if(!p.tool_calls||p.tool_calls.length===0)throw new Error("No tool calls found in the response.");const g=p.tool_calls.find(y=>y.name===d);if(!g)throw new Error(`No tool call found with name ${d}.`);return g.args});if(!i)return h.pipe(m).withConfig({runName:"StructuredOutput"});const l=F.assign({parsed:(p,g)=>m.invoke(p.raw,g)}),f=F.assign({parsed:()=>null}),c=l.withFallbacks({fallbacks:[f]});return Pe.from([{raw:h},c]).withConfig({runName:"StructuredOutputRunnable"})}}class Fe extends V{parseResultWithPrompt(t,n,s){return this.parseResult(t,s)}_baseMessageToString(t){return typeof t.content=="string"?t.content:this._baseMessageContentToString(t.content)}_baseMessageContentToString(t){return JSON.stringify(t)}async invoke(t,n){return typeof t=="string"?this._callWithConfig(async(s,a)=>this.parseResult([{text:s}],a==null?void 0:a.callbacks),t,{...n,runType:"parser"}):this._callWithConfig(async(s,a)=>this.parseResult([{message:s,text:this._baseMessageToString(s)}],a==null?void 0:a.callbacks),t,{...n,runType:"parser"})}}class Ft extends Fe{parseResult(t,n){return this.parse(t[0].text,n)}async parseWithPrompt(t,n,s){return this.parse(t,s)}_type(){throw new Error("_type not implemented")}}class Kt extends Error{constructor(t,n,s,a=!1){if(super(t),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=n,this.observation=s,this.sendToLLM=a,a&&(s===void 0||n===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Qe(this,"OUTPUT_PARSING_FAILURE")}}class $t extends Ft{async*_transform(t){for await(const n of t)typeof n=="string"?yield this.parseResult([{text:n}]):yield this.parseResult([{message:n,text:this._baseMessageToString(n)}])}async*transform(t,n){yield*this._transformStreamWithConfig(t,this._transform.bind(this),{...n,runType:"parser"})}}class Ht extends $t{constructor(t){super(t),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(t==null?void 0:t.diff)??this.diff}async*_transform(t){let n,s;for await(const a of t){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let r;if(Ze(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");r=new q({message:a,text:a.content})}else if(z(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");r=new q({message:et(a),text:a.content})}else r=new tt({text:a});s===void 0?s=r:s=s.concat(r);const o=await this.parsePartialResult([s]);o!=null&&!nt(o,n)&&(this.diff?yield this._diff(n,o):yield o,n=o)}}getFormatInstructions(){return""}}class Bt extends Ht{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(t,n){if(n)return t?jt(t,n):[{op:"replace",path:"",value:n}]}async parsePartialResult(t){return oe(t[0].text)}async parse(t){return oe(t,JSON.parse)}getFormatInstructions(){return""}}function A(e){if(typeof e=="object"&&e!==null){const t={...e};"additionalProperties"in t&&delete t.additionalProperties,"$schema"in t&&delete t.$schema,"strict"in t&&delete t.strict;for(const n in t)n in t&&(Array.isArray(t[n])?t[n]=t[n].map(A):typeof t[n]=="object"&&t[n]!==null&&(t[n]=A(t[n])));return t}return e}function J(e){const t=A(K(e)?Ne(e):e),{$schema:n,...s}=t;return s}function Yt(e){const t=A(e),{$schema:n,...s}=t;return s}function qt(e){return e!==void 0&&Array.isArray(e.lc_namespace)}function Wt(e){return e!==void 0&&V.isRunnable(e)&&"lc_name"in e.constructor&&typeof e.constructor.lc_name=="function"&&e.constructor.lc_name()==="RunnableToolLike"}function Jt(e){return!!e&&typeof e=="object"&&"name"in e&&"schema"in e&&(K(e.schema)||e.schema!=null&&typeof e.schema=="object"&&"type"in e.schema&&typeof e.schema.type=="string"&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function Ke(e){return Jt(e)||Wt(e)||qt(e)}const C=[];for(let e=0;e<256;++e)C.push((e+256).toString(16).slice(1));function Vt(e,t=0){return(C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]).toLowerCase()}let Y;const zt=new Uint8Array(16);function Xt(){if(!Y){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Y=crypto.getRandomValues.bind(crypto)}return Y(zt)}const Qt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Oe={randomUUID:Qt};function $e(e,t,n){var a;if(Oe.randomUUID&&!e)return Oe.randomUUID();e=e||{};const s=e.random??((a=e.rng)==null?void 0:a.call(e))??Xt();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Vt(s)}function Zt(e){const t=e._getType();return at.isInstance(e)?e.role:t==="tool"?t:e.name??t}function en(e){switch(e){case"supervisor":case"ai":case"model":return"model";case"system":return"system";case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${e}`)}}function tn(e){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};if("mimeType"in e&&"fileUri"in e)return{fileData:{mimeType:e.mimeType,fileUri:e.fileUri}};throw new Error("Invalid media content")}function nn(e,t){var n;return(n=t.map(s=>X(s)?s.tool_calls??[]:[]).flat().find(s=>s.id===e.tool_call_id))==null?void 0:n.name}function sn(e){return{providerName:"Google Gemini",fromStandardTextBlock(n){return{text:n.text}},fromStandardImageBlock(n){if(!e)throw new Error("This model does not support images");if(n.source_type==="url"){const s=H({dataUrl:n.url});return s?{inlineData:{mimeType:s.mime_type,data:s.data}}:{fileData:{mimeType:n.mime_type??"",fileUri:n.url}}}if(n.source_type==="base64")return{inlineData:{mimeType:n.mime_type??"",data:n.data}};throw new Error(`Unsupported source type: ${n.source_type}`)},fromStandardAudioBlock(n){if(!e)throw new Error("This model does not support audio");if(n.source_type==="url"){const s=H({dataUrl:n.url});return s?{inlineData:{mimeType:s.mime_type,data:s.data}}:{fileData:{mimeType:n.mime_type??"",fileUri:n.url}}}if(n.source_type==="base64")return{inlineData:{mimeType:n.mime_type??"",data:n.data}};throw new Error(`Unsupported source type: ${n.source_type}`)},fromStandardFileBlock(n){if(!e)throw new Error("This model does not support files");if(n.source_type==="text")return{text:n.text};if(n.source_type==="url"){const s=H({dataUrl:n.url});return s?{inlineData:{mimeType:s.mime_type,data:s.data}}:{fileData:{mimeType:n.mime_type??"",fileUri:n.url}}}if(n.source_type==="base64")return{inlineData:{mimeType:n.mime_type??"",data:n.data}};throw new Error(`Unsupported source type: ${n.source_type}`)}}}function Ie(e,t){var n;if(rt(e))return it(e,sn(t));if(e.type==="text")return{text:e.text};if(e.type==="executableCode")return{executableCode:e.executableCode};if(e.type==="codeExecutionResult")return{codeExecutionResult:e.codeExecutionResult};if(e.type==="image_url"){if(!t)throw new Error("This model does not support images");let s;if(typeof e.image_url=="string")s=e.image_url;else if(typeof e.image_url=="object"&&"url"in e.image_url)s=e.image_url.url;else throw new Error("Please provide image as base64 encoded data URL");const[a,r]=s.split(",");if(!a.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[o,i]=a.replace(/^data:/,"").split(";");if(i!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:r,mimeType:o}}}else{if(e.type==="media")return tn(e);if(e.type==="tool_use")return{functionCall:{name:e.name,args:e.input}};if((n=e.type)!=null&&n.includes("/")&&e.type.split("/").length===2&&"data"in e&&typeof e.data=="string")return{inlineData:{mimeType:e.type,data:e.data}};if("functionCall"in e)return;throw"type"in e?new Error(`Unknown content type ${e.type}`):new Error(`Unknown content ${JSON.stringify(e)}`)}}function an(e,t,n){var r;if(ot(e)){const o=e.name??nn(e,n);if(o===void 0)throw new Error(`Google requires a tool name for each tool call response, and we could not infer a called tool name for ToolMessage "${e.id}" from your passed messages. Please populate a "name" field on that ToolMessage explicitly.`);const i=Array.isArray(e.content)?e.content.map(d=>Ie(d,t)).filter(d=>d!==void 0):e.content;return e.status==="error"?[{functionResponse:{name:o,response:{error:{details:i}}}}]:[{functionResponse:{name:o,response:{result:i}}}]}let s=[];const a=[];return typeof e.content=="string"&&e.content&&a.push({text:e.content}),Array.isArray(e.content)&&a.push(...e.content.map(o=>Ie(o,t)).filter(o=>o!==void 0)),X(e)&&((r=e.tool_calls)!=null&&r.length)&&(s=e.tool_calls.map(o=>({functionCall:{name:o.name,args:o.args}}))),[...a,...s]}function Te(e,t,n=!1){return e.reduce((s,a,r)=>{if(!z(a))throw new Error("Unsupported message input");const o=Zt(a);if(o==="system"&&r!==0)throw new Error("System message should be the first one");const i=en(o),d=s.content[s.content.length];if(!s.mergeWithPreviousContent&&d&&d.role===i)throw new Error("Google Generative AI requires alternate messages between authors");const u=an(a,t,e.slice(0,r));if(s.mergeWithPreviousContent){const l=s.content[s.content.length-1];if(!l)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return l.parts.push(...u),{mergeWithPreviousContent:!1,content:s.content}}let h=i;(h==="function"||h==="system"&&!n)&&(h="user");const m={role:h,parts:u};return{mergeWithPreviousContent:o==="system"&&!n,content:[...s.content,m]}},{content:[],mergeWithPreviousContent:!1}).content}function on(e,t){var u,h,m;if(!e.candidates||e.candidates.length===0||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};const n=e.functionCalls(),[s]=e.candidates,{content:a,...r}=s;let o;Array.isArray(a==null?void 0:a.parts)&&a.parts.length===1&&a.parts[0].text?o=a.parts[0].text:Array.isArray(a==null?void 0:a.parts)&&a.parts.length>0?o=a.parts.map(l=>"text"in l?{type:"text",text:l.text}:"executableCode"in l?{type:"executableCode",executableCode:l.executableCode}:"codeExecutionResult"in l?{type:"codeExecutionResult",codeExecutionResult:l.codeExecutionResult}:l):o=[];let i="";if(typeof o=="string")i=o;else if(Array.isArray(o)&&o.length>0){const l=o.find(f=>"text"in f);i=(l==null?void 0:l.text)??i}return{generations:[{text:i,message:new W({content:o??"",tool_calls:n==null?void 0:n.map(l=>({...l,type:"tool_call",id:"id"in l&&typeof l.id=="string"?l.id:$e()})),additional_kwargs:{...r},usage_metadata:t==null?void 0:t.usageMetadata}),generationInfo:r}],llmOutput:{tokenUsage:{promptTokens:(u=t==null?void 0:t.usageMetadata)==null?void 0:u.input_tokens,completionTokens:(h=t==null?void 0:t.usageMetadata)==null?void 0:h.output_tokens,totalTokens:(m=t==null?void 0:t.usageMetadata)==null?void 0:m.total_tokens}}}}function rn(e,t){if(!e.candidates||e.candidates.length===0)return null;const n=e.functionCalls(),[s]=e.candidates,{content:a,...r}=s;let o;Array.isArray(a==null?void 0:a.parts)&&a.parts.every(u=>"text"in u)?o=a.parts.map(u=>u.text).join(""):Array.isArray(a==null?void 0:a.parts)?o=a.parts.map(u=>"text"in u?{type:"text",text:u.text}:"executableCode"in u?{type:"executableCode",executableCode:u.executableCode}:"codeExecutionResult"in u?{type:"codeExecutionResult",codeExecutionResult:u.codeExecutionResult}:u):o=[];let i="";if(o&&typeof o=="string")i=o;else if(Array.isArray(o)){const u=o.find(h=>"text"in h);i=(u==null?void 0:u.text)??""}const d=[];return n&&d.push(...n.map(u=>({...u,args:JSON.stringify(u.args),index:t.index,type:"tool_call_chunk",id:"id"in u&&typeof u.id=="string"?u.id:$e()}))),new q({text:i,message:new st({content:o||"",name:a?a.role:void 0,tool_call_chunks:d,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:r})}function un(e){return e.every(t=>"functionDeclarations"in t&&Array.isArray(t.functionDeclarations))?e:[{functionDeclarations:e.map(t=>{if(Ke(t)){const n=J(t.schema);return n.type==="object"&&"properties"in n&&Object.keys(n.properties).length===0?{name:t.name,description:t.description}:{name:t.name,description:t.description,parameters:n}}return ke(t)?{name:t.function.name,description:t.function.description??"A function available to call.",parameters:Yt(t.function.parameters)}:t})}]}class Se extends Fe{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=t.keyName,this.returnSingle=t.returnSingle??this.returnSingle,this.zodSchema=t.zodSchema}async _validateResult(t){if(this.zodSchema===void 0)return t;const n=await ut(this.zodSchema,t);if(n.success)return n.data;throw new Kt(`Failed to parse. Text: "${JSON.stringify(t,null,2)}". Error: ${JSON.stringify(n.error.issues)}`,JSON.stringify(t,null,2))}async parseResult(t){const n=t.flatMap(r=>{const{message:o}=r;return!("tool_calls"in o)||!Array.isArray(o.tool_calls)?[]:o.tool_calls});if(n[0]===void 0)throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[s]=n;return await this._validateResult(s.args)}}function Ae(e,t){const n=ln(e),s=dn(n,t);return{tools:n,toolConfig:s}}function ln(e){let t=[];const n=[];return e.forEach(a=>{if(Ke(a)){const[r]=un([a]);r.functionDeclarations&&t.push(...r.functionDeclarations)}else if(ke(a)){const{functionDeclarations:r}=cn(a);if(r)t.push(...r);else throw new Error("Failed to convert OpenAI structured tool to GenerativeAI tool")}else n.push(a)}),n.find(a=>"functionDeclarations"in a)?n.map(a=>{if((t==null?void 0:t.length)>0&&"functionDeclarations"in a){const r={functionDeclarations:[...a.functionDeclarations||[],...t]};return t=[],r}return a}):[...n,...t.length>0?[{functionDeclarations:t}]:[]]}function cn(e){return{functionDeclarations:[{name:e.function.name,description:e.function.description,parameters:A(e.function.parameters)}]}}function dn(e,t){if(!e.length||!t)return;const{toolChoice:n,allowedFunctionNames:s}=t,a={any:P.ANY,auto:P.AUTO,none:P.NONE};if(n&&["any","auto","none"].includes(n))return{functionCallingConfig:{mode:a[n]??"MODE_UNSPECIFIED",allowedFunctionNames:s}};if(typeof n=="string"||s)return{functionCallingConfig:{mode:P.ANY,allowedFunctionNames:[...s??[],...n&&typeof n=="string"?[n]:[]]}}}class fn extends O{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get lc_aliases(){return{apiKey:"google_api_key"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")||this.model.startsWith("gemini-2")}constructor(t){if(super(t),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models","google_genai"]}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"json",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"convertSystemMessageToHumanContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=t.model.replace(/^models\//,""),this.maxOutputTokens=t.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=t.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>2))throw new Error("`temperature` must be in the range of [0.0,2.0]");if(this.topP=t.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=t.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=t.stopSequences??this.stopSequences,this.apiKey=t.apiKey??lt("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=t.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(s=>s.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=t.streaming??this.streaming,this.json=t.json,this.client=new Ee(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK,...this.json?{responseMimeType:"application/json"}:{}}},{apiVersion:t.apiVersion,baseUrl:t.baseUrl}),this.streamUsage=t.streamUsage??this.streamUsage}useCachedContent(t,n,s){this.apiKey&&(this.client=new Ee(this.apiKey).getGenerativeModelFromCachedContent(t,n,s))}get useSystemInstruction(){return typeof this.convertSystemMessageToHumanContent=="boolean"?!this.convertSystemMessageToHumanContent:this.computeUseSystemInstruction}get computeUseSystemInstruction(){return this.model==="gemini-1.0-pro-001"||this.model.startsWith("gemini-pro-vision")||this.model.startsWith("gemini-1.0-pro-vision")?!1:this.model!=="gemini-pro"}getLsParams(t){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:t.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(t,n){var s;return this.withConfig({tools:(s=Ae(t))==null?void 0:s.tools,...n})}invocationParams(t){var s;const n=(s=t==null?void 0:t.tools)!=null&&s.length?Ae(t.tools,{toolChoice:t.tool_choice,allowedFunctionNames:t.allowedFunctionNames}):void 0;return t!=null&&t.responseSchema?(this.client.generationConfig.responseSchema=t.responseSchema,this.client.generationConfig.responseMimeType="application/json"):(this.client.generationConfig.responseSchema=void 0,this.client.generationConfig.responseMimeType=this.json?"application/json":void 0),{...n!=null&&n.tools?{tools:n.tools}:{},...n!=null&&n.toolConfig?{toolConfig:n.toolConfig}:{}}}async _generate(t,n,s){var h,m,l;const a=Te(t,this._isMultimodalModel,this.useSystemInstruction);let r=a;if(a[0].role==="system"){const[f]=a;this.client.systemInstruction=f,r=a.slice(1)}const o=this.invocationParams(n);if(this.streaming){const f={},c=this._streamResponseChunks(t,n,s),p={};for await(const y of c){const _=((h=y.generationInfo)==null?void 0:h.completion)??0;p[_]===void 0?p[_]=y:p[_]=p[_].concat(y)}return{generations:Object.entries(p).sort(([y],[_])=>parseInt(y,10)-parseInt(_,10)).map(([y,_])=>_),llmOutput:{estimatedTokenUsage:f}}}const i=await this.completionWithRetry({...o,contents:r});let d;if("usageMetadata"in i.response){const f=i.response.usageMetadata;d={input_tokens:f.promptTokenCount??0,output_tokens:f.candidatesTokenCount??0,total_tokens:f.totalTokenCount??0}}const u=on(i.response,{usageMetadata:d});return((m=u.generations)==null?void 0:m.length)>0&&await(s==null?void 0:s.handleLLMNewToken(((l=u.generations[0])==null?void 0:l.text)??"")),u}async*_streamResponseChunks(t,n,s){const a=Te(t,this._isMultimodalModel,this.useSystemInstruction);let r=a;if(a[0].role==="system"){const[m]=a;this.client.systemInstruction=m,r=a.slice(1)}const i={...this.invocationParams(n),contents:r},d=await this.caller.callWithOptions({signal:n==null?void 0:n.signal},async()=>{const{stream:m}=await this.client.generateContentStream(i);return m});let u,h=0;for await(const m of d){if("usageMetadata"in m&&this.streamUsage!==!1&&n.streamUsage!==!1){const f=m.usageMetadata;if(!u)u={input_tokens:f.promptTokenCount??0,output_tokens:f.candidatesTokenCount??0,total_tokens:f.totalTokenCount??0};else{const c=(f.candidatesTokenCount??0)-u.output_tokens;u={input_tokens:0,output_tokens:c,total_tokens:c}}}const l=rn(m,{usageMetadata:u,index:h});h+=1,l&&(yield l,await(s==null?void 0:s.handleLLMNewToken(l.text??"")))}}async completionWithRetry(t,n){return this.caller.callWithOptions({signal:n==null?void 0:n.signal},async()=>{var s;try{return await this.client.generateContent(t)}catch(a){throw(s=a.message)!=null&&s.includes("400 Bad Request")&&(a.status=400),a}})}withStructuredOutput(t,n){const s=t,a=n==null?void 0:n.name,r=n==null?void 0:n.method,o=n==null?void 0:n.includeRaw;if(r==="jsonMode")throw new Error('ChatGoogleGenerativeAI only supports "jsonSchema" or "functionCalling" as a method.');let i,d;if(r==="functionCalling"){let l=a??"extract",f;if(K(s)){const c=J(s);f=[{functionDeclarations:[{name:l,description:c.description??"A function available to call.",parameters:c}]}],d=new Se({returnSingle:!0,keyName:l,zodSchema:s})}else{let c;typeof s.name=="string"&&typeof s.parameters=="object"&&s.parameters!=null?(c=s,c.parameters=A(s.parameters),l=s.name):c={name:l,description:s.description??"",parameters:A(s)},f=[{functionDeclarations:[c]}],d=new Se({returnSingle:!0,keyName:l})}i=this.bindTools(f).withConfig({allowedFunctionNames:[l]})}else{const l=J(s);i=this.withConfig({responseSchema:l}),d=new Bt}if(!o)return i.pipe(d).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const u=F.assign({parsed:(l,f)=>d.invoke(l.raw,f)}),h=F.assign({parsed:()=>null}),m=u.withFallbacks({fallbacks:[h]});return Pe.from([{raw:i},m]).withConfig({runName:"StructuredOutputRunnable"})}}chrome.action.onClicked.addListener(async e=>{console.log("Extension clicked, opening side panel..."),chrome.sidePanel&&chrome.sidePanel.open?await chrome.sidePanel.open({windowId:e.windowId}):console.error("Side Panel API not available.")});const hn=`You are Nova, an AI assistant with superpowers powered by tools.

If the user asks to go to a website, do NOT just say you're going  actually use the "navigate_to" tool. You must always use tools when interacting with the browser.

Don't try to summarize or imitate tool behavior  call the tool directly with the right arguments.

You only use natural responses when asked conversational or non-browser questions.`,mn=`You are Nova, a helpful and intelligent AI assistant.

Your job is to support the user by providing clear, accurate, and friendly answers through conversation. You respond using your own reasoning and knowledge, without relying on any external systems or automation.

Always aim to be thoughtful, informative, and easy to understand. Focus on being genuinely useful and kind in every response.`,pn=void 0;console.warn("[Nova] No API key found. Set VITE_GEMINI_API_KEY in your .env.local file.");const T={},gn=new fn({model:"gemini-2.0-flash",apiKey:pn}).bindTools([xe]);chrome.runtime.onMessage.addListener((e,t,n)=>{const{type:s,userId:a,question:r}=e;if(s==="ask-gemini")return(async()=>{try{T[a]||(T[a]=[new M(mn)]),T[a].push(new M(r));const o=await gn.invoke(T[a]),{content:i,tool_calls:d}=o;if(d&&d.length>0){for(const u of d)if(u.name==="navigate_to"){const h=await xe.func(u.args);console.log("Tool result:",h),T[a].push(new W(h)),n({answer:h})}}else T[a].push(new W(i)),n({answer:o.content})}catch(o){console.error("Gemini error:",o),n({error:"Failed to generate response"})}})(),!0;if(s==="reset-chat")return T[a]=[new M(hn)],n({success:!0}),!0});
